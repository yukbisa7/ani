<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Anichin Clone</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --bg-dark: #1a1a1a; --primary: #f97316; }
        body { background-color: #111; color: #eee; font-family: sans-serif; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        input, textarea, select {
            background-color: #252525; border: 1px solid #333; color: white; padding: 8px 12px; border-radius: 6px; width: 100%; outline: none;
        }
        input:focus, textarea:focus, select:focus { border-color: var(--primary); }
        label { font-size: 0.85rem; color: #9ca3af; font-weight: bold; margin-bottom: 4px; display: block; }
        th { text-align: left; padding: 12px; background: #252525; color: #9ca3af; font-size: 0.8rem; text-transform: uppercase; }
        td { padding: 12px; border-bottom: 1px solid #222; }
        tr:hover { background: #1a1a1a; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- LOADING -->
    <div id="loading-overlay" class="fixed inset-0 z-[60] bg-black bg-opacity-80 flex items-center justify-center hidden">
        <div class="animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-orange-500"></div>
    </div>

    <!-- NAVBAR -->
    <header id="navbar" class="bg-[#1f1f1f] border-b border-[#333] sticky top-0 z-50 hidden">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <span class="text-xl font-extrabold text-white tracking-tighter">ADMIN<span class="text-orange-500">PANEL</span></span>
            <nav class="flex gap-4 text-sm font-bold">
                <button onclick="admin.showDashboard()" class="text-gray-300 hover:text-white">DASHBOARD</button>
                <a href="index.html" target="_blank" class="text-gray-300 hover:text-orange-500"><i class="fas fa-external-link-alt"></i> LIHAT WEB</a>
                <button onclick="admin.logout()" class="text-red-500 hover:text-red-400">LOGOUT</button>
            </nav>
        </div>
    </header>

    <main class="container mx-auto px-4 py-6 flex-grow">
        <!-- LOGIN VIEW -->
        <div id="view-login" class="flex items-center justify-center min-h-[80vh]">
            <div class="bg-[#1f1f1f] p-8 rounded-lg border border-[#333] w-full max-w-sm shadow-2xl">
                <h2 class="text-2xl font-bold mb-6 text-center text-orange-500">Login Admin</h2>
                <form onsubmit="admin.handleLogin(event)" class="space-y-4">
                    <div><label>Username</label><input type="text" id="login-user" required></div>
                    <div><label>Password</label><input type="password" id="login-pass" required></div>
                    <div id="login-error" class="text-red-500 text-sm text-center hidden font-bold">Salah!</div>
                    <button type="submit" class="w-full bg-orange-600 text-white font-bold py-2 rounded hover:bg-orange-700">MASUK</button>
                </form>
            </div>
        </div>

        <!-- DASHBOARD VIEW -->
        <div id="view-dashboard" class="hidden fade-in">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                <h2 class="text-2xl font-bold border-l-4 border-orange-500 pl-3">Manajemen Konten</h2>
                <div class="flex gap-2">
                    <button onclick="admin.refreshData()" class="bg-[#333] px-4 py-2 rounded hover:bg-[#444] text-sm"><i class="fas fa-sync"></i> Refresh</button>
                    <button onclick="admin.showFormTitle()" class="bg-green-600 px-4 py-2 rounded hover:bg-green-700 text-white text-sm font-bold"><i class="fas fa-plus"></i> Tambah Anime</button>
                    <button onclick="admin.showFormEpisode()" class="bg-blue-600 px-4 py-2 rounded hover:bg-blue-700 text-white text-sm font-bold"><i class="fas fa-video"></i> Tambah Episode</button>
                </div>
            </div>
            
            <div class="bg-[#1f1f1f] rounded border border-[#333] overflow-hidden overflow-x-auto">
                <table class="w-full text-sm text-gray-300">
                    <thead><tr><th>Poster</th><th>Judul</th><th>Jadwal</th><th>Status</th><th>Eps</th><th class="text-right">Aksi</th></tr></thead>
                    <tbody id="table-body"></tbody>
                </table>
            </div>
        </div>

        <!-- FORM ANIME VIEW -->
        <div id="view-form-title" class="hidden fade-in max-w-3xl mx-auto">
            <div class="bg-[#1f1f1f] p-6 rounded border border-[#333]">
                <h2 id="form-title-heading" class="text-xl font-bold mb-6 text-orange-500 border-b border-[#333] pb-2">Tambah Anime</h2>
                <form onsubmit="admin.saveTitle(event)" class="space-y-4">
                    <input type="hidden" id="title-original-slug">
                    
                    <div>
                        <label>Judul Anime</label>
                        <input type="text" id="t-title" oninput="admin.autoFill('title')" placeholder="Contoh: Soul Land" required>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label>Slug</label><input type="text" id="t-slug" class="bg-[#111]" required></div>
                        <div><label>ID</label><input type="text" id="t-id" class="bg-[#111]" required></div>
                    </div>
                    <div><label>Poster URL</label><input type="text" id="t-poster" required></div>
                    <div><label>Deskripsi</label><textarea id="t-desc" rows="3" required></textarea></div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div><label>Genre</label><input type="text" id="t-genre" placeholder="Action, Fantasy" required></div>
                        <div><label>Tahun</label><input type="text" id="t-release" required></div>
                    </div>

                    <!-- UPDATE: Tambahan Field Jadwal -->
                    <div class="grid grid-cols-2 gap-4 p-4 bg-[#252525] rounded border border-[#333]">
                        <div>
                            <label class="text-orange-500">Hari Rilis</label>
                            <select id="t-day">
                                <option value="">- Tidak Tentu -</option>
                                <option value="Senin">Senin</option>
                                <option value="Selasa">Selasa</option>
                                <option value="Rabu">Rabu</option>
                                <option value="Kamis">Kamis</option>
                                <option value="Jumat">Jumat</option>
                                <option value="Sabtu">Sabtu</option>
                                <option value="Minggu">Minggu</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-orange-500">Jam Tayang</label>
                            <input type="text" id="t-time" placeholder="Contoh: 20:00 WIB">
                        </div>
                    </div>

                    <div>
                        <label>Status</label>
                        <select id="t-status">
                            <option value="Ongoing">Ongoing</option>
                            <option value="Completed">Completed</option>
                        </select>
                    </div>

                    <div class="flex gap-3 pt-4 border-t border-[#333] mt-4">
                        <button type="submit" class="bg-orange-600 text-white px-6 py-2 rounded font-bold hover:bg-orange-700">SIMPAN</button>
                        <button type="button" onclick="admin.deleteTitle()" id="btn-delete-title" class="bg-red-600 text-white px-4 py-2 rounded hidden">HAPUS</button>
                        <button type="button" onclick="admin.showDashboard()" class="bg-[#333] text-gray-300 px-4 py-2 rounded ml-auto">BATAL</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- FORM EPISODE VIEW -->
        <div id="view-form-episode" class="hidden fade-in max-w-3xl mx-auto">
            <div class="bg-[#1f1f1f] p-6 rounded border border-[#333]">
                <h2 id="form-ep-heading" class="text-xl font-bold mb-6 text-blue-500 border-b border-[#333] pb-2">Tambah Episode</h2>
                <form onsubmit="admin.saveEpisode(event)" class="space-y-4">
                    <input type="hidden" id="ep-original-slug">
                    <div><label class="text-orange-500">Pilih Anime</label><select id="ep-parent-slug" required class="font-bold"></select></div>
                    <hr class="border-[#333]">
                    <div><label>Judul Episode</label><input type="text" id="ep-title" oninput="admin.autoFill('episode')" required></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label>Slug</label><input type="text" id="ep-slug" class="bg-[#111]" required></div>
                        <div><label>ID</label><input type="text" id="ep-id" class="bg-[#111]" required></div>
                    </div>
                    <div><label>Video URL</label><input type="text" id="ep-video" required></div>
                    <div><label>Deskripsi</label><textarea id="ep-desc" rows="2"></textarea></div>
                    <div class="flex gap-3 pt-4 border-t border-[#333] mt-4">
                        <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded font-bold hover:bg-blue-700">SIMPAN</button>
                        <button type="button" onclick="admin.deleteEpisode()" id="btn-delete-ep" class="bg-red-600 text-white px-4 py-2 rounded hidden">HAPUS</button>
                        <button type="button" onclick="admin.showDashboard()" class="bg-[#333] text-gray-300 px-4 py-2 rounded ml-auto">BATAL</button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <script>
        const API_URL = 'https://hosting.nakibo8225.workers.dev/json/b22b00540aee';

        window.admin = {
            data: { titles: [], users: [] },

            autoFill: function(type) {
                const isTitle = type === 'title';
                const original = document.getElementById(isTitle ? 'title-original-slug' : 'ep-original-slug').value;
                if(original) return;
                const text = document.getElementById(isTitle ? 't-title' : 'ep-title').value;
                document.getElementById(isTitle ? 't-id' : 'ep-id').value = text.split(' ').map(w=>w.charAt(0).toUpperCase()).join('').replace(/[^A-Z0-9]/g,'');
                document.getElementById(isTitle ? 't-slug' : 'ep-slug').value = text.toLowerCase().replace(/[^a-z0-9\s]/g,'').trim().replace(/\s+/g,'-');
            },

            init: function() {
                if(sessionStorage.getItem('isAdmin') === 'true') this.fetchData();
                else this.showView('view-login');
            },

            handleLogin: async function(e) {
                e.preventDefault();
                this.loading(true);
                try {
                    const res = await fetch(API_URL);
                    const json = await res.json();
                    const valid = json.users ? json.users.find(u => u.username === document.getElementById('login-user').value && u.password === document.getElementById('login-pass').value) : null;
                    if(valid) {
                        sessionStorage.setItem('isAdmin', 'true');
                        this.data = json;
                        this.renderDashboard();
                        this.showView('view-dashboard');
                    } else document.getElementById('login-error').classList.remove('hidden');
                } catch(err) { alert("Error"); }
                this.loading(false);
            },

            logout: function() { sessionStorage.removeItem('isAdmin'); location.reload(); },
            fetchData: async function() {
                this.loading(true);
                try {
                    const res = await fetch(API_URL);
                    this.data = await res.json();
                    if(!this.data.titles) this.data.titles = [];
                    this.renderDashboard();
                    this.showView('view-dashboard');
                } catch(e) { alert("Gagal"); }
                this.loading(false);
            },
            refreshData: function() { this.fetchData(); },

            saveToApi: async function() {
                this.loading(true);
                try {
                    await fetch(API_URL, {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(this.data)});
                    this.loading(false); return true;
                } catch(e) { this.loading(false); alert("Gagal simpan"); return false; }
            },

            renderDashboard: function() {
                const tbody = document.getElementById('table-body');
                const titles = this.data.titles;
                if(titles.length===0) { tbody.innerHTML='<tr><td colspan="6" class="text-center py-4">Kosong</td></tr>'; return; }
                tbody.innerHTML = titles.map(t => `
                    <tr class="border-b border-[#333]">
                        <td class="w-12"><img src="${t.poster}" class="w-8 h-10 object-cover rounded"></td>
                        <td><div class="font-bold text-white">${t.title}</div><div class="text-[10px] text-gray-500">${t.slug}</div></td>
                        <!-- Tampilkan Jadwal -->
                        <td><span class="text-xs text-orange-400">${t.schedule ? t.schedule.day : '-'}</span><br><span class="text-[10px] text-gray-500">${t.schedule ? t.schedule.time : ''}</span></td>
                        <td><span class="text-xs text-gray-400">${t.status}</span></td>
                        <td>${t.episodes?t.episodes.length:0}</td>
                        <td class="text-right">
                            <button onclick="admin.editTitle('${t.slug}')" class="text-orange-500 mr-2"><i class="fas fa-edit"></i></button>
                            <button onclick="admin.showFormEpisode('${t.slug}')" class="text-blue-500"><i class="fas fa-plus-circle"></i></button>
                        </td>
                    </tr>
                `).join('');
            },

            showFormTitle: function() {
                document.getElementById('form-title-heading').innerText = "Tambah Anime";
                document.getElementById('title-original-slug').value = "";
                document.getElementById('btn-delete-title').classList.add('hidden');
                ['t-id','t-slug','t-title','t-poster','t-desc','t-genre','t-release','t-time'].forEach(id=>document.getElementById(id).value="");
                document.getElementById('t-day').value = "";
                this.showView('view-form-title');
            },

            editTitle: function(slug) {
                const t = this.data.titles.find(x => x.slug === slug);
                if(!t) return;
                document.getElementById('form-title-heading').innerText = "Edit Anime";
                document.getElementById('title-original-slug').value = t.slug;
                document.getElementById('btn-delete-title').classList.remove('hidden');
                
                document.getElementById('t-id').value = t.id;
                document.getElementById('t-slug').value = t.slug;
                document.getElementById('t-title').value = t.title;
                document.getElementById('t-poster').value = t.poster;
                document.getElementById('t-desc').value = t.description;
                document.getElementById('t-genre').value = Array.isArray(t.genre) ? t.genre.join(', ') : t.genre;
                document.getElementById('t-release').value = t.release_date;
                document.getElementById('t-status').value = t.status;
                
                // Load Jadwal
                if(t.schedule) {
                    document.getElementById('t-day').value = t.schedule.day || "";
                    document.getElementById('t-time').value = t.schedule.time || "";
                } else {
                    document.getElementById('t-day').value = "";
                    document.getElementById('t-time').value = "";
                }

                this.showView('view-form-title');
            },

            saveTitle: async function(e) {
                e.preventDefault();
                const orig = document.getElementById('title-original-slug').value;
                const newObj = {
                    id: document.getElementById('t-id').value,
                    slug: document.getElementById('t-slug').value,
                    title: document.getElementById('t-title').value,
                    poster: document.getElementById('t-poster').value,
                    description: document.getElementById('t-desc').value,
                    genre: document.getElementById('t-genre').value.split(',').map(s=>s.trim()),
                    release_date: document.getElementById('t-release').value,
                    status: document.getElementById('t-status').value,
                    // SIMPAN JADWAL
                    schedule: {
                        day: document.getElementById('t-day').value,
                        time: document.getElementById('t-time').value
                    },
                    episodes: [], views: 0
                };

                if(orig) {
                    const idx = this.data.titles.findIndex(t => t.slug === orig);
                    if(idx!==-1) {
                        newObj.episodes = this.data.titles[idx].episodes;
                        newObj.views = this.data.titles[idx].views || 0;
                        this.data.titles[idx] = newObj;
                    }
                } else {
                    this.data.titles.push(newObj);
                }
                if(await this.saveToApi()) { this.renderDashboard(); this.showView('view-dashboard'); }
            },

            deleteTitle: async function() {
                if(confirm("Hapus?")) {
                    this.data.titles = this.data.titles.filter(t => t.slug !== document.getElementById('title-original-slug').value);
                    if(await this.saveToApi()) { this.renderDashboard(); this.showView('view-dashboard'); }
                }
            },

            // (Episode functions same as before, shortened for brevity but logic intact)
            showFormEpisode: function(slug){ 
                const s = document.getElementById('ep-parent-slug'); s.innerHTML='<option value="">Pilih</option>'; 
                this.data.titles.forEach(t=>s.innerHTML+=`<option value="${t.slug}">${t.title}</option>`); s.disabled=false;
                if(slug){s.value=slug;s.disabled=true;}
                document.getElementById('ep-original-slug').value="";
                document.getElementById('btn-delete-ep').classList.add('hidden');
                ['ep-id','ep-slug','ep-title','ep-video','ep-desc'].forEach(i=>document.getElementById(i).value="");
                this.showView('view-form-episode');
            },
            saveEpisode: async function(e){
                e.preventDefault(); const p = document.getElementById('ep-parent-slug').value;
                const idx = this.data.titles.findIndex(t=>t.slug===p);
                const ep = {
                    id:document.getElementById('ep-id').value, slug:document.getElementById('ep-slug').value,
                    title:document.getElementById('ep-title').value, video_url:document.getElementById('ep-video').value,
                    description:document.getElementById('ep-desc').value
                };
                const orig = document.getElementById('ep-original-slug').value;
                let eps = this.data.titles[idx].episodes||[];
                if(orig){ const ei = eps.findIndex(x=>x.slug===orig); if(ei!==-1) eps[ei]=ep; } else eps.push(ep);
                this.data.titles[idx].episodes = eps;
                if(await this.saveToApi()){this.renderDashboard();this.showView('view-dashboard');}
            },
            deleteEpisode: async function(){
                 if(confirm("Hapus?")) {
                    const p = document.getElementById('ep-parent-slug').value;
                    const idx = this.data.titles.findIndex(t=>t.slug===p);
                    this.data.titles[idx].episodes = this.data.titles[idx].episodes.filter(e=>e.slug!==document.getElementById('ep-original-slug').value);
                    if(await this.saveToApi()){this.renderDashboard();this.showView('view-dashboard');}
                 }
            },

            showView: function(id) {
                ['view-login','view-dashboard','view-form-title','view-form-episode'].forEach(v=>document.getElementById(v).classList.add('hidden'));
                document.getElementById(id).classList.remove('hidden');
                document.getElementById('navbar').classList.toggle('hidden', id==='view-login');
            },
            loading: function(s) { document.getElementById('loading-overlay').classList.toggle('hidden', !s); }
        };
        document.addEventListener('DOMContentLoaded', () => window.admin.init());
    </script>
</body>
</html>